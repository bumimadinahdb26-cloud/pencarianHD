<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Aplikasi Pasien HD Malahayati</title>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
<style>
/* CSS STYLES */
:root{
  --white:#fff; --green:#2e7d32; --green-light:#4caf50; --green-dark:#1b5e20;
  --green-main:#1b7f5f; --purple-brown:#5d4037; --gold:#ffc107; --gold-light:#ffecb3;
  --gold-dark:#ff8f00; --orange:#ff9800; --orange-light:#ffb74d; --orange-dark:#e65100;
  --card:#ffffff; --border:#cfe3da; --text:#1b1b1b;
  --font:'Caveat', cursive; --font-arabic:'Amiri', serif;
  --wa-color:#25D366; --print-color:#7b1fa2; --danger-color:#e53935; --lab-color:#0288d1;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Arial,sans-serif;background:linear-gradient(180deg, rgba(46, 125, 50, 0.55) 0%, rgba(46, 125, 50, 0.35) 25%, rgba(93, 64, 55, 0.45) 65%, rgba(93, 64, 55, 0.65) 100%), linear-gradient(135deg, #1b5e20 0%, #2e7d32 30%, #4a3728 70%, #5d4037 100%); color:var(--white); min-height:100vh; margin:0; padding:16px; padding-bottom:180px; overflow-x:hidden; position:relative;}
.stars{position:fixed; inset:0; z-index:0; pointer-events:none; background:radial-gradient(circle, var(--gold) 1px, transparent 2px), radial-gradient(circle, var(--gold-light) 1px, transparent 2px); background-size:60px 60px, 100px 100px; animation:twinkle 3s ease-in-out infinite; opacity:0.4;}
@keyframes twinkle{0%, 100%{opacity:.25} 50%{opacity:.5}}
.sun-container{position:fixed; top:50px; right:20px; z-index:1; pointer-events:none;}
.sun{width:60px; height:60px; background:radial-gradient(circle, var(--gold-light) 0%, var(--gold) 50%, var(--orange) 100%); border-radius:50%; box-shadow:0 0 30px var(--gold), 0 0 60px rgba(255, 193, 7, 0.4); animation:sunGlow 4s ease-in-out infinite;}
@keyframes sunGlow{0%, 100%{box-shadow:0 0 30px var(--gold), 0 0 60px rgba(255, 193, 7, 0.4); transform:scale(1);} 50%{box-shadow:0 0 45px var(--orange), 0 0 80px rgba(255, 152, 0, 0.5); transform:scale(1.03);}}
.moon-container{position:fixed; top:45px; left:15px; z-index:1; pointer-events:none;}
.moon{width:55px; height:55px; filter:drop-shadow(0 0 12px var(--gold-light)); animation:moonGlow 5s ease-in-out infinite;}
.moon svg{width:100%; height:100%; fill:var(--gold-light);}
@keyframes moonGlow{0%, 100%{filter:drop-shadow(0 0 12px var(--gold-light));} 50%{filter:drop-shadow(0 0 20px var(--gold));}}

.ramadhan-header{position:relative; z-index:2; text-align:center; padding:20px 15px; margin:70px auto 15px; max-width:320px; background:linear-gradient(135deg, rgba(27,94,32,0.05) 0%, rgba(46,125,50,0.03) 100%); border-radius:20px; border:2px solid var(--gold); box-shadow:0 4px 20px rgba(255,193,7,0.2); animation:fadeInDown 1.2s ease-out;}
.header-title{font-size:16px; font-weight:700; color:var(--gold); letter-spacing:4px; margin-bottom:8px;}
.greeting{font-family:var(--font-arabic); font-size:18px; font-weight:700; color:var(--gold); text-shadow:0 0 10px rgba(255,193,7,0.6);}
.clock-container{margin-top:10px; padding-top:8px; border-top:1px solid rgba(255,193,7,0.3);}
.clock{font-size:20px; letter-spacing:2px; color:var(--white);}
.clock-date{font-size:11px; margin-top:2px; color:var(--gold-light);}

/* Toolbar & Quick Menu */
.toolbar{position:relative; z-index:2; max-width:480px; margin:0 auto 5px;}
.search-box{display:flex; align-items:center; background:rgba(255,255,255,0.92); backdrop-filter:blur(8px); border:2px solid var(--gold); border-radius:30px; padding:0 8px 0 16px; box-shadow:0 4px 20px rgba(255,193,7,0.3);}
.search-box #search{flex:1; border:none; outline:none; padding:12px 0; font-size:14px; background:transparent; color:var(--text);}
.search-box button{background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%); border:none; cursor:pointer; padding:10px; font-size:18px; border-radius:50%; box-shadow:0 2px 8px rgba(255,193,7,0.4);}

/* NEW: Quick Menu Styles */
.quick-menu{display:flex; gap:8px; margin:10px auto 15px; max-width:480px; position:relative; z-index:2;}
.quick-btn{flex:1; text-decoration:none; text-align:center; padding:10px; border-radius:12px; font-size:12px; font-weight:700; color:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.2); transition:transform 0.2s; display:flex; align-items:center; justify-content:center; gap:5px;}
.quick-btn:hover{transform:translateY(-2px);}
.quick-btn.lab{background:linear-gradient(135deg, #0288d1 0%, #01579b 100%); border:1px solid #81d4fa;}
.quick-btn.input{background:linear-gradient(135deg, var(--green-main) 0%, var(--green-dark) 100%); border:1px solid #a5d6a7;}

#hasil{position:relative; z-index:2; max-width:480px; margin:0 auto; color:var(--gold-light); text-align:center; font-size:14px;}

.card{background:rgba(255,255,255,0.88); backdrop-filter:blur(8px); border:1px solid var(--gold); border-radius:16px; padding:14px; margin-bottom:12px; position:relative; box-shadow:0 4px 15px rgba(0,0,0,0.15); text-align:left;}
.card.expired{border:2px solid var(--danger-color); background:rgba(255,235,238,0.9);}
.nama{font-size:16px; font-weight:700; color:var(--green-dark);}
.mr{font-size:11px; color:#666; text-align:right;}
.info{font-size:12px; line-height:1.6; margin-top:6px; color:var(--text);}
.badge{display:inline-block; padding:4px 10px; border-radius:999px; background:linear-gradient(135deg, var(--green-main) 0%, var(--green-dark) 100%); color:#fff; font-size:11px; font-weight:700;}
.badge.danger{background:linear-gradient(135deg, var(--danger-color) 0%, #b71c1c 100%);}
.action-btn{display:inline-block; margin:4px 2px; padding:5px 12px; border-radius:12px; font-size:11px; font-weight:700; border:none; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.1); transition:transform 0.2s; text-decoration:none; color:#fff;}
.view-btn{background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%);}
.share-btn{background:linear-gradient(135deg, #25D366 0%, #128C7E 100%);}
.form-btn{background:linear-gradient(135deg, var(--print-color) 0%, #9c27b0 100%);}
.lab-btn-inline{background:linear-gradient(135deg, #0288d1 0%, #01579b 100%);}
.action-btn:hover{transform:scale(1.05);}

/* Modal & Footer Styles (Sama seperti sebelumnya) */
.modal-view{display:none; position:fixed; z-index:2000; inset:0; background:rgba(0,0,0,.85); backdrop-filter:blur(10px);}
.modal-view-content{background:linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); margin:20px auto; padding:0; border-radius:20px; max-width:500px; max-height:90vh; overflow-y:auto; border:3px solid var(--gold); box-shadow:0 20px 60px rgba(0,0,0,0.5); animation:modalPop 0.3s ease;}
.modal-view-header{display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%); border-radius:17px 17px 0 0; position:sticky; top:0;}
.modal-view-header h4{margin:0; font-size:16px; color:#fff;}
.modal-view-close{cursor:pointer; font-size:24px; font-weight:bold; color:#fff; width:32px; height:32px; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.2); border-radius:50%;}
.modal-view-body{padding:20px;}
.view-card{background:rgba(255,255,255,0.95); border-radius:16px; overflow:hidden; padding:20px;}
.input-group{margin-bottom:12px;}
.input-group label{display:block; font-size:12px; color:#666; margin-bottom:4px;}
.input-group input, .input-group textarea{width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; font-size:14px;}
.btn-save{width:100%; padding:12px; background:var(--green-main); color:#fff; border:none; border-radius:20px; font-weight:bold; cursor:pointer; margin-top:10px;}
.toast{position:fixed; bottom:100px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--green-main); color:#fff; padding:12px 24px; border-radius:30px; font-size:13px; font-weight:600; box-shadow:0 6px 20px rgba(0,0,0,0.3); z-index:3000; opacity:0; transition:all 0.3s ease; border:2px solid var(--gold);}
.toast.show{opacity:1; transform:translateX(-50%) translateY(0);}

@media (max-width:360px){.greeting{font-size:16px} .quick-btn{font-size:11px; padding:8px;}}
</style>
</head>
<body>

<div class="stars"></div>
<div class="sun-container"><div class="sun"></div></div>
<div class="moon-container"><div class="moon"><svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg></div></div>

<!-- HEADER -->
<div class="ramadhan-header">
  <div class="header-title">HD MALAHAYATI</div>
  <div class="greeting">Sistem Informasi Pasien HD</div>
  <div class="clock-container">
    <div class="clock" id="clock">--:--:--</div>
    <div class="clock-date" id="clockDate">--</div>
  </div>
</div>

<!-- SEARCH -->
<div class="toolbar">
  <div class="search-box">
    <input id="search" placeholder="Cari Nama / No MR..." onkeyup="cariData()">
    <button onclick="cariData()">üîç</button>
  </div>
</div>

<!-- NEW: QUICK MENU -->
<div class="quick-menu">
  <!-- Tombol Laborat -->
  <a href="https://script.google.com/macros/s/AKfycbzOHwRa8rDJDIP0baYhxFNy2RU7hVtAGLWbqFttmP8SW8xsBTgZNm5R3eVXQkzmFflA/exec" target="_blank" class="quick-btn lab">
    üî¨ Cek Hasil Laborat
  </a>
</div>

<!-- HASIL PENCARIAN -->
<div id="hasil">Ketik minimal 2 karakter untuk mencari...</div>

<!-- MODAL INPUT PEMERIKSAAN -->
<div id="modalView" class="modal-view">
  <div class="modal-view-content">
    <div class="modal-view-header">
      <h4>Input Pemeriksaan Pasien</h4>
      <span class="modal-view-close" onclick="closeModal()">‚úï</span>
    </div>
    <div class="modal-view-body">
      <div class="view-card">
        <h3 style="margin-bottom:10px; color:var(--green-dark);" id="modalNama">-</h3>
        <input type="hidden" id="inputMR">
        <input type="hidden" id="inputNama">
        
        <div class="input-group">
          <label>Tekanan Darah (mmHg)</label>
          <input type="text" id="inputTD" placeholder="Contoh: 120/80">
        </div>
        
        <div class="input-group">
          <label>Obat-obatan</label>
          <textarea id="inputObat" rows="3" placeholder="Input obat yang diberikan..."></textarea>
        </div>
        
        <div class="input-group">
          <label>Catatan</label>
          <input type="text" id="inputCatatan" placeholder="Catatan tambahan">
        </div>
        
        <button class="btn-save" onclick="simpanPemeriksaan()">SIMPAN DATA</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast">Berhasil!</div>

<script>
// ===== FUNGSI CLOCK =====
(function(){
  const c=document.getElementById('clock');
  const d=document.getElementById('clockDate');
  function tick(){
    const n=new Date();
    c.textContent=n.toLocaleTimeString('id-ID',{hour12:false});
    d.textContent=n.toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  }
  tick(); setInterval(tick,1000);
})();

// ===== FUNGSI CARI DATA (Backend) =====
function cariData() {
  const keyword = document.getElementById('search').value;
  if(keyword.length < 2) {
    document.getElementById('hasil').innerHTML = "Ketik minimal 2 karakter...";
    return;
  }
  document.getElementById('hasil').innerHTML = "Mencari data...";
  google.script.run.withSuccessHandler(tampilkanHasil).searchPatient(keyword);
}

// ===== TAMPILKAN HASIL KE HTML =====
function tampilkanHasil(data) {
  const container = document.getElementById('hasil');
  if(!data || data.length === 0) {
    container.innerHTML = "<div style='background:#fff;padding:20px;border-radius:10px;color:#666;'>Data tidak ditemukan.</div>";
    return;
  }
  
  let html = "";
  data.forEach(p => {
    let badgeClass = p.is_expired ? "danger" : "";
    let cardClass = p.is_expired ? "expired" : "";
    
    html += `
    <div class="card ${cardClass}">
      <div style="display:flex; justify-content:space-between;">
        <div class="nama">${p.nama}</div>
        <div class="mr">MR: ${p.no_mr}</div>
      </div>
      <div class="info">
        <div style="margin-bottom:8px;">
          <span class="badge ${badgeClass}">Rujukan: ${p.status_rujukan}</span>
        </div>
        <p>Jadwal HD: ${p.jadwal_hd || '-'}</p>
        <p>Shift: ${p.shift || '-'}</p>
        <div style="margin-top:10px; display:flex; gap:5px; flex-wrap:wrap;">
          <button class="action-btn form-btn" onclick='bukaFormPemeriksaan(${JSON.stringify(p)})'>Input TD</button>
          <button class="action-btn lab-btn-inline" onclick='cariKeLaborat("${p.no_mr}")'>Cek Lab</button>
        </div>
      </div>
    </div>`;
  });
  container.innerHTML = html;
}

// ===== MODAL & FORM LOGIC =====
function bukaFormPemeriksaan(pasien) {
  document.getElementById('modalNama').innerText = pasien.nama;
  document.getElementById('inputMR').value = pasien.no_mr;
  document.getElementById('inputNama').value = pasien.nama;
  document.getElementById('inputTD').value = "";
  document.getElementById('inputObat').value = "";
  document.getElementById('inputCatatan').value = "";
  document.getElementById('modalView').style.display = 'block';
}

function closeModal() {
  document.getElementById('modalView').style.display = 'none';
}

function simpanPemeriksaan() {
  const data = {
    no_mr: document.getElementById('inputMR').value,
    nama: document.getElementById('inputNama').value,
    tekanan_darah: document.getElementById('inputTD').value,
    obat: document.getElementById('inputObat').value,
    catatan: document.getElementById('inputCatatan').value
  };
  google.script.run.withSuccessHandler(onSaveSuccess).saveExamination(data);
}

function onSaveSuccess(response) {
  closeModal();
  showToast(response);
}

// Fungsi untuk cari ke lab (Jika aplikasi lab menerima parameter)
function cariKeLaborat(mr) {
  // Ini akan membuka link lab di tab baru. 
  // Jika aplikasi lab Anda mendukung pencarian otomatis via URL (misal: .../exec?search=MR001), 
  // Anda bisa menambahkan parameter di bawah ini.
  // Contoh: var url = "https://script.google.com/macros/s/.../exec?mr=" + mr;
  
  // Untuk sekarang, kita arahkan saja ke halaman utama lab.
  var url = "https://script.google.com/macros/s/AKfycbzOHwRa8rDJDIP0baYhxFNy2RU7hVtAGLWbqFttmP8SW8xsBTgZNm5R3eVXQkzmFflA/exec";
  window.open(url, '_blank');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

document.getElementById('modalView').addEventListener('click', function(e) {
  if(e.target === this) closeModal();
});
</script>
</body>
</html>
