<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Aplikasi Pasien HD Malahayati - Ramadhan Kareem</title>

<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --white:#fff;
  --green:#2e7d32;
  --green-light:#4caf50;
  --green-dark:#1b5e20;
  --green-main:#1b7f5f;
  --purple-brown:#5d4037;
  --gold:#ffc107;
  --gold-light:#ffecb3;
  --gold-dark:#ff8f00;
  --orange:#ff9800;
  --orange-light:#ffb74d;
  --orange-dark:#e65100;
  --card:#ffffff;
  --border:#cfe3da;
  --text:#1b1b1b;
  --font:'Caveat', cursive;
  --font-arabic:'Amiri', serif;
  --wa-color:#25D366;
  --print-color:#7b1fa2;
  --danger-color:#e53935;
  --tiktok-color:#000000;
  --lab-color:#0288d1;
  --telegram-color:#0088cc;
  --sms-color:#ff9800;
  --tel-color:#4caf50;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:Arial,sans-serif;
  background:
    linear-gradient(180deg, 
      rgba(46, 125, 50, 0.55) 0%, 
      rgba(46, 125, 50, 0.35) 25%,
      rgba(93, 64, 55, 0.45) 65%,
      rgba(93, 64, 55, 0.65) 100%
    ),
    linear-gradient(135deg, 
      #1b5e20 0%, 
      #2e7d32 30%, 
      #4a3728 70%, 
      #5d4037 100%
    );
  color:var(--white);
  min-height:100vh;
  min-height:100dvh;
  margin:0;
  padding:16px;
  padding-bottom:180px;
  overflow-x:hidden;
  position:relative;
}

.stars{
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  background:
    radial-gradient(circle, var(--gold) 1px, transparent 2px),
    radial-gradient(circle, var(--gold-light) 1px, transparent 2px);
  background-size:60px 60px, 100px 100px;
  animation:twinkle 3s ease-in-out infinite;
  opacity:0.4;
}
@keyframes twinkle{
  0%, 100%{opacity:.25}
  50%{opacity:.5}
}

.sun-container{
  position:fixed;
  top:50px;
  right:20px;
  z-index:1;
  pointer-events:none;
}

.sun{
  width:60px;
  height:60px;
  background:radial-gradient(circle, var(--gold-light) 0%, var(--gold) 50%, var(--orange) 100%);
  border-radius:50%;
  box-shadow:0 0 30px var(--gold), 0 0 60px rgba(255, 193, 7, 0.4);
  animation:sunGlow 4s ease-in-out infinite;
}

@keyframes sunGlow{
  0%, 100%{
    box-shadow:0 0 30px var(--gold), 0 0 60px rgba(255, 193, 7, 0.4);
    transform:scale(1);
  }
  50%{
    box-shadow:0 0 45px var(--orange), 0 0 80px rgba(255, 152, 0, 0.5);
    transform:scale(1.03);
  }
}

.sun-cloud{
  position:absolute;
  top:-8px;
  right:-12px;
  z-index:2;
}

.sun-cloud svg{
  width:70px;
  height:45px;
  fill:rgba(255,255,255,0.8);
  filter:drop-shadow(0 3px 5px rgba(0,0,0,0.1));
  animation:cloudFloat 8s ease-in-out infinite;
}

.moon-container{
  position:fixed;
  top:45px;
  left:15px;
  z-index:1;
  pointer-events:none;
}

.moon{
  width:55px;
  height:55px;
  filter:drop-shadow(0 0 12px var(--gold-light));
  animation:moonGlow 5s ease-in-out infinite;
}

.moon svg{
  width:100%;
  height:100%;
  fill:var(--gold-light);
}

@keyframes moonGlow{
  0%, 100%{filter:drop-shadow(0 0 12px var(--gold-light));}
  50%{filter:drop-shadow(0 0 20px var(--gold));}
}

.moon-cloud{
  position:absolute;
  top:12px;
  left:-18px;
  z-index:2;
}

.moon-cloud svg{
  width:60px;
  height:35px;
  fill:rgba(255,255,255,0.7);
  filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1));
  animation:cloudFloat 7s ease-in-out infinite reverse;
}

@keyframes cloudFloat{
  0%, 100%{transform:translateX(0)}
  50%{transform:translateX(6px)}
}

/* ===== HEADER RAMADHAN ===== */
.ramadhan-header{
  position:relative;
  z-index:2;
  text-align:center;
  padding:20px 15px;
  margin:70px auto 15px;
  max-width:320px;
  background:linear-gradient(135deg, rgba(27,94,32,0.05) 0%, rgba(46,125,50,0.03) 100%);
  border-radius:20px;
  border:2px solid var(--gold);
  box-shadow:0 4px 20px rgba(255,193,7,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
  animation:fadeInDown 1.2s ease-out;
}

.ramadhan-header::before{
  content:'';
  position:absolute;
  top:-8px;
  left:50%;
  transform:translateX(-50%);
  width:120px;
  height:16px;
  background:var(--gold);
  border-radius:0 0 60px 60px;
  box-shadow:0 0 15px rgba(255,193,7,0.5);
}

.ramadhan-header::after{
  content:'';
  position:absolute;
  bottom:-8px;
  left:50%;
  transform:translateX(-50%);
  width:120px;
  height:16px;
  background:var(--gold);
  border-radius:60px 60px 0 0;
  box-shadow:0 0 15px rgba(255,193,7,0.5);
}

.header-corner{
  position:absolute;
  width:20px;
  height:20px;
  border:2px solid var(--gold);
}
.header-corner.tl{top:6px;left:6px;border-right:none;border-bottom:none;border-radius:8px 0 0 0;}
.header-corner.tr{top:6px;right:6px;border-left:none;border-bottom:none;border-radius:0 8px 0 0;}
.header-corner.bl{bottom:6px;left:6px;border-right:none;border-top:none;border-radius:0 0 0 8px;}
.header-corner.br{bottom:6px;right:6px;border-left:none;border-top:none;border-radius:0 0 8px 0;}

.header-title{
  font-size:16px;
  font-weight:700;
  color:var(--gold);
  letter-spacing:4px;
  margin-bottom:8px;
  text-shadow:0 2px 4px rgba(0,0,0,0.3);
}

.greeting-arabic{
  font-family:var(--font-arabic);
  font-size:16px;
  color:var(--gold-light);
  margin-bottom:4px;
  text-shadow:0 0 8px rgba(255,193,7,0.5);
  white-space:nowrap;
}

.greeting{
  font-family:var(--font-arabic);
  font-size:18px;
  font-weight:700;
  color:var(--gold);
  text-shadow:0 0 10px rgba(255,193,7,0.6), 0 2px 2px rgba(0,0,0,0.3);
  letter-spacing:1px;
  white-space:nowrap;
}

.clock-container{
  margin-top:10px;
  padding-top:8px;
  border-top:1px solid rgba(255,193,7,0.3);
}
.clock{
  font-size:20px;
  letter-spacing:2px;
  color:var(--white);
  text-shadow:0 0 10px rgba(255,193,7,0.5);
}
.clock-date{
  font-size:11px;
  margin-top:2px;
  color:var(--gold-light);
}

@keyframes fadeInDown{
  from{opacity:0;transform:translateY(-15px);}
  to{opacity:1;transform:translateY(0);}
}

/* ===== USER INFO BAR ===== */
.user-bar{
  position:relative;
  z-index:2;
  max-width:480px;
  margin:0 auto 10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:rgba(255,255,255,0.1);
  backdrop-filter:blur(8px);
  border-radius:12px;
  padding:10px 14px;
  border:1px solid var(--gold);
}

.user-info{
  display:flex;
  align-items:center;
  gap:10px;
  color:var(--gold-light);
  font-size:13px;
}

.user-avatar{
  width:36px;
  height:36px;
  background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  font-weight:700;
  color:var(--green-dark);
}

.user-name{
  font-weight:700;
  color:var(--white);
  font-size:14px;
}

.user-details{
  font-size:10px;
  color:var(--gold-light);
  margin-top:2px;
}

.btn-logout{
  background:rgba(255,255,255,0.1);
  border:1px solid var(--gold);
  color:var(--gold-light);
  padding:6px 14px;
  border-radius:8px;
  font-size:11px;
  cursor:pointer;
  transition:all 0.2s;
}
.btn-logout:hover{
  background:var(--gold);
  color:var(--green-dark);
}

/* ===== TOOLBAR ===== */
.toolbar{
  position:relative;
  z-index:2;
  max-width:480px;
  margin:0 auto 12px;
}

.search-box{
  display:flex;
  align-items:center;
  background:rgba(255,255,255,0.92);
  backdrop-filter:blur(8px);
  border:2px solid var(--gold);
  border-radius:30px;
  padding:0 8px 0 16px;
  position:relative;
  box-shadow:0 4px 20px rgba(255,193,7,0.3);
}

.search-box #search{
  flex:1;
  border:none;
  outline:none;
  padding:12px 0;
  font-size:14px;
  background:transparent;
  min-width:80px;
  color:var(--text);
}

.separator{
  width:1px;
  height:21px;
  background:var(--gold-light);
  margin:0 10px;
}

.date-wrapper{
  position:relative;
  display:flex;
  align-items:center;
}

.date-placeholder{
  position:absolute;
  left:0;
  top:50%;
  transform:translateY(-50%);
  color:#999;
  font-size:14px;
  pointer-events:none;
  transition:opacity 0.2s;
  white-space:nowrap;
}

.date-wrapper.has-value .date-placeholder{
  opacity:0;
}

.search-box #searchDate{
  border:none;
  outline:none;
  padding:12px 0;
  font-size:14px;
  background:transparent;
  width:120px;
  cursor:pointer;
  color:var(--text);
  position:relative;
  z-index:1;
}

.search-box button{
  background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%);
  border:none;
  cursor:pointer;
  padding:10px;
  font-size:18px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 2px 8px rgba(255,193,7,0.4);
  transition:transform 0.2s, box-shadow 0.2s;
}
.search-box button:hover{
  transform:scale(1.1);
  box-shadow:0 4px 12px rgba(255,152,0,0.5);
}

/* ===== QUICK MENU ===== */
.quick-menu{
  display:flex;
  gap:8px;
  margin:10px auto 15px;
  max-width:480px;
  position:relative;
  z-index:2;
}

.quick-btn{
  flex:1;
  text-decoration:none;
  text-align:center;
  padding:10px;
  border-radius:12px;
  font-size:11px;
  font-weight:700;
  color:#fff;
  box-shadow:0 4px 10px rgba(0,0,0,0.2);
  transition:transform 0.2s;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:5px;
  border:1px solid rgba(255,255,255,0.2);
}
.quick-btn:hover{transform:translateY(-2px);}
.quick-btn.lab{
  background:linear-gradient(135deg, var(--gold-dark) 0%, var(--orange-dark) 100%);
  border-color:var(--gold);
}
.quick-btn.history{
  background:linear-gradient(135deg, var(--green-main) 0%, var(--green-dark) 100%);
  border-color:var(--gold);
}

/* ===== KONTEN ===== */
#hasil{
  position:relative;
  z-index:2;
  max-width:480px;
  margin:0 auto;
  color:var(--gold-light);
  text-align:center;
  font-size:14px;
}

.card{
  background:rgba(255,255,255,0.88);
  backdrop-filter:blur(8px);
  border:1px solid var(--gold);
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
  position:relative;
  box-shadow:0 4px 15px rgba(0,0,0,0.15);
  text-align:left;
}

.card.selesai{
  background:rgba(255,246,204,0.9);
  border-color:var(--gold-dark);
}

.card.selesai::after{
  content:"SELESAI";
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  font-weight:800;
  color:rgba(160,120,0,.25);
  transform:rotate(-20deg);
  pointer-events:none;
}

.row{display:flex;justify-content:space-between;}
.nama{font-size:16px;font-weight:700;color:var(--green-dark);}
.mr{font-size:11px;color:#666;text-align:right;}
.info{font-size:12px;line-height:1.6;margin-top:6px;color:var(--text);}

.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%);
  color:#fff;
  font-size:11px;
  font-weight:700;
  box-shadow:0 2px 6px rgba(255,193,7,0.3);
}

.countdown{
  margin-top:6px;
  font-size:11px;
  font-weight:700;
  color:var(--green-dark);
}

.action-btn{
  display:inline-block;
  margin:3px 2px;
  padding:6px 10px;
  border-radius:10px;
  font-size:11px;
  font-weight:700;
  border:none;
  cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  transition:transform 0.2s, box-shadow 0.2s;
  text-decoration:none;
}
.action-btn:hover{
  transform:scale(1.05);
  box-shadow:0 4px 10px rgba(0,0,0,0.2);
}
.view-btn{
  background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%);
  color:#fff;
}
.record-btn{
  background:linear-gradient(135deg, var(--green-main) 0%, var(--green-dark) 100%);
  color:#fff;
  border:1px solid var(--gold);
}
.wa-share-btn{
  background:linear-gradient(135deg, #25D366 0%, #128C7E 100%);
  color:#fff;
}
.tg-share-btn{
  background:linear-gradient(135deg, #0088cc 0%, #005f8f 100%);
  color:#fff;
}
.sms-btn{
  background:linear-gradient(135deg, var(--orange) 0%, var(--orange-dark) 100%);
  color:#fff;
}
.tel-btn{
  background:linear-gradient(135deg, var(--tel-color) 0%, #2e7d32 100%);
  color:#fff;
}
.pdf-btn{
  background:linear-gradient(135deg, #e53935 0%, #c62828 100%);
  color:#fff;
}
.delete-btn{
  background:linear-gradient(135deg, #757575 0%, #424242 100%);
  color:#fff;
}

/* ===== FLOATING SOCIAL FOOTER ===== */
.social-footer{
  position:fixed;
  right:16px;
  bottom:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  z-index:1000;
}

.tiktok-btn{
  width:48px;
  height:48px;
  border-radius:50%;
  background:var(--tiktok-color);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:0 6px 20px rgba(0,0,0,.4);
  animation:pulseTiktok 2s infinite;
  border:2px solid var(--gold);
  transition:transform 0.2s;
}
.tiktok-btn:hover{transform:scale(1.1);}
.tiktok-btn svg{width:22px;height:22px;}

@keyframes pulseTiktok{
  0%{box-shadow:0 0 0 0 rgba(0,0,0,.6), 0 0 0 0 rgba(255,193,7,0.4);}
  70%{box-shadow:0 0 0 10px rgba(0,0,0,0), 0 0 0 6px rgba(255,193,7,0);}
  100%{box-shadow:0 0 0 0 rgba(0,0,0,0), 0 0 0 0 rgba(255,193,7,0);}
}

.wa-btn{
  width:48px;
  height:48px;
  border-radius:50%;
  background:linear-gradient(135deg, #25D366 0%, #128C7E 100%);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:0 6px 20px rgba(37,211,102,.4);
  animation:pulseWA 1.8s infinite;
  border:2px solid var(--gold);
  transition:transform 0.2s;
}
.wa-btn:hover{transform:scale(1.1);}
.wa-btn img{width:22px;height:22px;}

.footer-text{
  font-size:9px;
  color:var(--gold-light);
  text-shadow:0 1px 2px rgba(0,0,0,0.5);
  white-space:nowrap;
  opacity:0.8;
  writing-mode:vertical-rl;
  text-orientation:mixed;
  transform:rotate(180deg);
  margin-top:4px;
}

@keyframes pulseWA{
  0%{box-shadow:0 0 0 0 rgba(37,211,102,.6), 0 0 0 0 rgba(255,193,7,0.4);}
  70%{box-shadow:0 0 0 14px rgba(37,211,102,0), 0 0 0 8px rgba(255,193,7,0);}
  100%{box-shadow:0 0 0 0 rgba(37,211,102,0), 0 0 0 0 rgba(255,193,7,0);}
}

.wa-panel{
  position:fixed;
  right:16px;
  bottom:140px;
  width:220px;
  background:linear-gradient(135deg, var(--green-main) 0%, var(--green-dark) 100%);
  color:#fff;
  border-radius:16px;
  padding:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
  border:1px solid var(--gold);
  display:none;
  z-index:1000;
  animation:slideUp .25s ease;
}
.wa-panel.show{display:block;}

@keyframes slideUp{
  from{opacity:0;transform:translateY(12px);}
  to{opacity:1;transform:translateY(0);}
}

.wa-panel h4{
  margin:0 0 8px;
  font-size:13px;
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid rgba(255,193,7,0.3);
  padding-bottom:6px;
}
.wa-panel a{
  display:block;
  text-decoration:none;
  color:#fff;
  font-size:12px;
  padding:6px 0;
  border-bottom:1px solid rgba(255,255,255,.15);
  transition:padding-left 0.2s;
}
.wa-panel a:hover{padding-left:6px;}
.wa-panel a:last-child{border:none;}

/* ===== MODAL LOGIN & REGISTER ===== */
.modal-login{
  display:none;
  position:fixed;
  z-index:2000;
  inset:0;
  background:rgba(0,0,0,.9);
  backdrop-filter:blur(10px);
  align-items:center;
  justify-content:center;
  overflow-y:auto;
  padding:20px 0;
}

.modal-login.show{
  display:flex;
}

.modal-login-content{
  background:linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
  border-radius:20px;
  padding:25px;
  max-width:350px;
  width:90%;
  border:3px solid var(--gold);
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
  animation:modalPop 0.3s ease;
  margin:auto;
}

@keyframes modalPop{
  from{opacity:0;transform:scale(0.9);}
  to{opacity:1;transform:scale(1);}
}

.login-header{
  text-align:center;
  margin-bottom:20px;
}

.login-header h3{
  color:var(--gold);
  font-size:18px;
  margin-bottom:5px;
}

.login-header p{
  color:var(--gold-light);
  font-size:12px;
}

.login-form .input-group{
  margin-bottom:12px;
}

.login-form label{
  display:block;
  color:var(--gold-light);
  font-size:12px;
  margin-bottom:4px;
}

.login-form input, .login-form select{
  width:100%;
  padding:10px;
  border:2px solid var(--gold);
  border-radius:10px;
  font-size:13px;
  background:rgba(255,255,255,0.9);
  color:var(--text);
}

.login-form input:focus, .login-form select:focus{
  outline:none;
  border-color:var(--orange);
}

.btn-login{
  width:100%;
  padding:12px;
  background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%);
  color:var(--green-dark);
  border:none;
  border-radius:20px;
  font-size:14px;
  font-weight:700;
  cursor:pointer;
  transition:transform 0.2s;
}

.btn-login:hover{
  transform:scale(1.02);
}

.login-error{
  color:var(--danger-color);
  font-size:12px;
  text-align:center;
  margin-top:10px;
  display:none;
}

.auth-switch{
  text-align:center;
  margin-top:15px;
  font-size:12px;
  color:var(--gold-light);
}

.auth-switch a{
  color:var(--gold);
  cursor:pointer;
  text-decoration:underline;
  font-weight:700;
}

/* ===== MODAL INPUT RECORD ===== */
.modal-record{
  display:none;
  position:fixed;
  z-index:2000;
  inset:0;
  background:rgba(0,0,0,.85);
  backdrop-filter:blur(10px);
}

.modal-record.show{
  display:block;
}

.modal-record-content{
  background:linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
  margin:20px auto;
  padding:0;
  border-radius:20px;
  max-width:500px;
  max-height:90vh;
  overflow-y:auto;
  border:3px solid var(--gold);
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
  animation:modalPop 0.3s ease;
}

.modal-record-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 20px;
  background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%);
  border-radius:17px 17px 0 0;
  position:sticky;
  top:0;
}

.modal-record-header h4{
  margin:0;
  font-size:16px;
  color:#fff;
}

.modal-close{
  cursor:pointer;
  font-size:24px;
  font-weight:bold;
  color:#fff;
  width:32px;
  height:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.2);
  border-radius:50%;
}

.modal-record-body{
  padding:20px;
}

.record-card{
  background:rgba(255,255,255,0.95);
  border-radius:16px;
  padding:20px;
}

.record-card h3{
  color:var(--green-dark);
  margin-bottom:15px;
  text-align:center;
}

.input-group{
  margin-bottom:12px;
}

.input-group label{
  display:block;
  font-size:12px;
  color:#666;
  margin-bottom:4px;
}

.input-group input, .input-group textarea, .input-group select{
  width:100%;
  padding:10px;
  border:1px solid #ddd;
  border-radius:8px;
  font-size:14px;
}

.input-group input:focus, .input-group textarea:focus, .input-group select:focus{
  outline:none;
  border-color:var(--gold);
}

.input-row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.section-title{
  font-size:14px;
  font-weight:700;
  color:var(--green-main);
  margin:15px 0 10px;
  padding-bottom:5px;
  border-bottom:1px solid var(--border);
}

.btn-save{
  width:100%;
  padding:12px;
  background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%);
  color:var(--green-dark);
  border:none;
  border-radius:20px;
  font-weight:700;
  cursor:pointer;
  margin-top:15px;
  font-size:14px;
}

.btn-save:disabled{
  opacity:0.6;
  cursor:not-allowed;
}

/* ===== MODAL VIEW ===== */
.modal-view{
  display:none;
  position:fixed;
  z-index:2000;
  inset:0;
  background:rgba(0,0,0,.85);
  backdrop-filter:blur(10px);
}

.modal-view.show{
  display:block;
}

.modal-view-content{
  background:linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
  margin:20px auto;
  padding:0;
  border-radius:20px;
  max-width:500px;
  max-height:90vh;
  overflow-y:auto;
  border:3px solid var(--gold);
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
  animation:modalPop 0.3s ease;
}

.modal-view-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 20px;
  background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%);
  border-radius:17px 17px 0 0;
  position:sticky;
  top:0;
}

.modal-view-header h4{
  margin:0;
  font-size:16px;
  color:#fff;
}

.view-card{
  background:rgba(255,255,255,0.95);
  border-radius:16px;
  overflow:hidden;
}

.view-card-header{
  background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%);
  padding:16px;
  text-align:center;
}

.view-patient-name{
  font-size:20px;
  font-weight:700;
  color:#fff;
  margin:0;
}

.view-patient-mr{
  font-size:12px;
  color:rgba(255,255,255,0.9);
  margin-top:4px;
}

.view-card-body{
  padding:16px;
}

.view-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 0;
  border-bottom:1px solid rgba(0,0,0,0.08);
}

.view-item:last-child{border-bottom:none;}

.view-label{
  font-size:13px;
  color:#666;
  display:flex;
  align-items:center;
  gap:8px;
}

.view-label-icon{
  width:24px;
  height:24px;
  background:linear-gradient(135deg, var(--gold-light) 0%, var(--gold) 100%);
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
}

.view-value{
  font-size:14px;
  font-weight:600;
  color:var(--green-dark);
}

.view-badge{
  display:inline-block;
  padding:6px 14px;
  border-radius:20px;
  background:linear-gradient(135deg, var(--gold) 0%, var(--orange) 100%);
  color:#fff;
  font-size:12px;
  font-weight:700;
}

/* ===== MODAL HISTORY ===== */
.modal-history{
  display:none;
  position:fixed;
  z-index:2000;
  inset:0;
  background:rgba(0,0,0,.85);
  backdrop-filter:blur(10px);
}

.modal-history.show{
  display:block;
}

.modal-history-content{
  background:linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
  margin:20px auto;
  padding:0;
  border-radius:20px;
  max-width:500px;
  max-height:90vh;
  overflow-y:auto;
  border:3px solid var(--gold);
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
  animation:modalPop 0.3s ease;
}

.history-list{
  padding:15px;
}

.history-item{
  background:rgba(255,255,255,0.95);
  border-radius:12px;
  padding:15px;
  margin-bottom:10px;
  border:1px solid var(--gold);
}

.history-item-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
  padding-bottom:8px;
  border-bottom:1px solid var(--border);
}

.history-date{
  font-weight:700;
  color:var(--green-dark);
  font-size:13px;
}

.history-patient{
  font-size:12px;
  color:#666;
}

.history-data{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  font-size:12px;
}

.history-data-item{
  background:rgba(255,193,7,0.1);
  padding:8px;
  border-radius:8px;
}

.history-data-item.full-width{
  grid-column: span 2;
}

.history-data-item label{
  font-size:10px;
  color:#666;
  display:block;
}

.history-data-item span{
  font-weight:700;
  color:var(--green-dark);
}

.history-actions{
  margin-top:10px;
  padding-top:10px;
  border-top:1px solid var(--border);
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}

.history-empty{
  text-align:center;
  padding:40px;
  color:var(--gold-light);
}

/* ===== TOAST ===== */
.toast{
  position:fixed;
  bottom:100px;
  left:50%;
  transform:translateX(-50%) translateY(100px);
  background:linear-gradient(135deg, var(--green-main) 0%, var(--green-dark) 100%);
  color:#fff;
  padding:12px 24px;
  border-radius:30px;
  font-size:13px;
  font-weight:600;
  box-shadow:0 6px 20px rgba(0,0,0,0.3);
  z-index:3000;
  opacity:0;
  transition:all 0.3s ease;
  border:2px solid var(--gold);
}
.toast.show{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}

.ornament{
  position:fixed;
  bottom:90px;
  font-size:18px;
  opacity:0.4;
  animation:float 4s ease-in-out infinite;
  z-index:1;
  pointer-events:none;
}
.ornament.left{left:12px; animation-delay:0s}
.ornament.right{right:12px; animation-delay:2s}

@keyframes float{
  0%, 100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}

/* ===== LOADING ===== */
.loading-spinner{
  display:inline-block;
  width:16px;
  height:16px;
  border:2px solid rgba(255,255,255,0.3);
  border-radius:50%;
  border-top-color:#fff;
  animation:spin 0.8s linear infinite;
}

@keyframes spin{
  to{transform:rotate(360deg)}
}

@media (min-width:481px){
  body{
    max-width:500px;
    margin:0 auto;
    border-radius:0;
  }
}

@media (max-width:360px){
  .greeting{font-size:16px}
  .greeting-arabic{font-size:14px}
  .ramadhan-header{margin-top:60px;padding:15px 10px}
  .header-title{font-size:13px}
  .clock{font-size:18px}
  .clock-date{font-size:10px}
  .sun{width:50px;height:50px}
  .moon{width:45px;height:45px}
  .search-box #search{font-size:13px}
  .search-box #searchDate{width:100px;font-size:13px}
  .card{padding:12px}
  .nama{font-size:15px}
  .quick-menu{flex-direction:column}
  .quick-btn{padding:8px}
  .tiktok-btn, .wa-btn{width:42px;height:42px}
  .footer-text{font-size:8px}
  .wa-panel{bottom:130px}
  .modal-login-content{padding:20px}
}
</style>
</head>

<body>

<div class="stars"></div>

<!-- MATAHARI DENGAN AWAN -->
<div class="sun-container">
  <div class="sun"></div>
  <div class="sun-cloud">
    <svg viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg">
      <ellipse cx="30" cy="35" rx="25" ry="18"/>
      <ellipse cx="55" cy="30" rx="30" ry="22"/>
      <ellipse cx="75" cy="38" rx="20" ry="15"/>
      <ellipse cx="45" cy="42" rx="22" ry="14"/>
    </svg>
  </div>
</div>

<!-- BULAN DENGAN AWAN -->
<div class="moon-container">
  <div class="moon">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
    </svg>
  </div>
  <div class="moon-cloud">
    <svg viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg">
      <ellipse cx="25" cy="32" rx="22" ry="16"/>
      <ellipse cx="50" cy="28" rx="28" ry="20"/>
      <ellipse cx="70" cy="35" rx="18" ry="13"/>
    </svg>
  </div>
</div>

<!-- HEADER RAMADHAN -->
<div class="ramadhan-header">
  <div class="header-corner tl"></div>
  <div class="header-corner tr"></div>
  <div class="header-corner bl"></div>
  <div class="header-corner br"></div>
  <div class="header-title">HD MALAHAYATI</div>
  <div class="greeting-arabic">ÿ±ŸéŸÖŸéÿ∂ŸéÿßŸÜŸè ŸÉŸéÿ±ŸêŸäŸÖŸå</div>
  <div class="greeting">Ramadhan Kareem</div>
  <div class="clock-container">
    <div class="clock" id="clock">--:--:--</div>
    <div class="clock-date" id="clockDate">--</div>
  </div>
</div>

<!-- USER BAR -->
<div class="user-bar" id="userBar" style="display:none;">
  <div class="user-info">
    <div class="user-avatar" id="userAvatar">U</div>
    <div>
      <div class="user-name" id="displayUserName">-</div>
      <div class="user-details" id="displayUserDetails">-</div>
    </div>
  </div>
  <button class="btn-logout" onclick="logout()">Keluar</button>
</div>

<!-- SEARCH -->
<div class="toolbar">
  <div class="search-box">
    <input id="search" placeholder="Cari Nama / MR / Ruang..." onkeyup="cari()">
    <div class="separator"></div>
    <div class="date-wrapper" id="dateWrapper">
      <input type="date" id="searchDate" onchange="cari(); checkDate();">
      <span class="date-placeholder">Filter Tanggal</span>
    </div>
    <button onclick="cari()">üîç</button>
  </div>
</div>

<!-- QUICK MENU -->
<div class="quick-menu">
  <a href="https://script.google.com/macros/s/AKfycbzOHwRa8rDJDIP0baYhxFNy2RU7hVtAGLWbqFttmP8SW8xsBTgZNm5R3eVXQkzmFflA/exec" target="_blank" class="quick-btn lab">
    üî¨ Cek Hasil Laborat
  </a>
  <button class="quick-btn history" onclick="openHistoryModal()">
    üìã Riwayat Pencatatan
  </button>
</div>

<!-- HASIL -->
<div id="hasil">Silakan login terlebih dahulu untuk mencari data pasien</div>

<!-- ORNAMEN -->
<div class="ornament left">üåô</div>
<div class="ornament right">‚≠ê</div>

<!-- FLOAT SOCIAL FOOTER -->
<div class="social-footer">
  <div class="footer-text">Created by Iman Waluyo</div>
  <a href="https://www.tiktok.com/@malahayatirssa" target="_blank" class="tiktok-btn" title="TikTok Malahayati">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path fill="#fff" d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/>
    </svg>
  </a>
  <div class="wa-btn" onclick="toggleWA()" title="WhatsApp Perawat HD">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg">
  </div>
</div>

<!-- PANEL WHATSAPP -->
<div class="wa-panel" id="waPanel">
  <h4>WA Perawat HD <span onclick="toggleWA()">‚úï</span></h4>
  <a href="https://wa.me/6287812203039" target="_blank">Iman Waluyo</a>
  <a href="https://wa.me/6287759964321" target="_blank">Cik Ros</a>
  <a href="https://wa.me/6285732737585" target="_blank">Linda</a>
  <a href="https://wa.me/6282335226625" target="_blank">Maria Wahyu</a>
  <a href="https://wa.me/6281234028503" target="_blank">Findy A</a>
  <a href="https://wa.me/6282257296694" target="_blank">Samsuga / Agus</a>
</div>

<!-- MODAL LOGIN -->
<div id="modalLogin" class="modal-login show">
  <div class="modal-login-content">
    
    <!-- FORM LOGIN -->
    <div id="formLogin">
      <div class="login-header">
        <h3>Login Aplikasi HD</h3>
        <p>Silakan masuk untuk melanjutkan</p>
      </div>
      <div class="login-form">
        <div class="input-group">
          <label>Nama Pengguna</label>
          <input type="text" id="loginUsername" placeholder="Masukkan nama pengguna">
        </div>
        <div class="input-group">
          <label>Kata Sandi</label>
          <input type="password" id="loginPassword" placeholder="Masukkan kata sandi">
        </div>
        <button class="btn-login" onclick="doLogin()">MASUK</button>
        <div class="login-error" id="loginError">Nama pengguna atau kata sandi salah!</div>
        <div class="auth-switch">
          Belum punya akun? <a onclick="showRegister()">Daftar di sini</a>
        </div>
      </div>
    </div>
    
    <!-- FORM REGISTER -->
    <div id="formRegister" style="display:none;">
      <div class="login-header">
        <h3>Daftar Akun Baru</h3>
        <p>Buat akun untuk mengakses aplikasi</p>
      </div>
      <div class="login-form">
        <div class="input-group">
          <label>Nama Lengkap</label>
          <input type="text" id="registerName" placeholder="Masukkan nama lengkap">
        </div>
        <div class="input-group">
          <label>Tempat, Tanggal Lahir</label>
          <input type="text" id="registerTTL" placeholder="Contoh: Bandung, 01-01-1990">
        </div>
        <div class="input-group">
          <label>Alamat</label>
          <input type="text" id="registerAlamat" placeholder="Masukkan alamat lengkap">
        </div>
        <div class="input-group">
          <label>Nama Pengguna</label>
          <input type="text" id="registerUsername" placeholder="Buat nama pengguna">
        </div>
        <div class="input-group">
          <label>Kata Sandi</label>
          <input type="password" id="registerPassword" placeholder="Buat kata sandi">
        </div>
        <div class="input-group">
          <label>Konfirmasi Kata Sandi</label>
          <input type="password" id="registerConfirm" placeholder="Ulangi kata sandi">
        </div>
        <button class="btn-login" onclick="doRegister()">DAFTAR</button>
        <div class="login-error" id="registerError">Error message</div>
        <div class="auth-switch">
          Sudah punya akun? <a onclick="showLogin()">Masuk di sini</a>
        </div>
      </div>
    </div>
    
  </div>
</div>

<!-- MODAL INPUT RECORD -->
<div id="modalRecord" class="modal-record">
  <div class="modal-record-content">
    <div class="modal-record-header">
      <h4>Pencatatan Harian HD</h4>
      <span class="modal-close" onclick="closeRecordModal()">‚úï</span>
    </div>
    <div class="modal-record-body">
      <div class="record-card">
        <h3 id="recordPatientName">-</h3>
        <div style="text-align:center; font-size:12px; color:#666; margin-bottom:15px;">
          MR: <span id="recordMRDisplay">-</span>
        </div>
        <input type="hidden" id="recordMR">
        <input type="hidden" id="recordNama">
        
        <div class="section-title">Sebelum Hemodialisa</div>
        <div class="input-row">
          <div class="input-group">
            <label>Berat Badan (kg)</label>
            <input type="number" id="inputBBSebelum" placeholder="Contoh: 65" step="0.1">
          </div>
          <div class="input-group">
            <label>Tekanan Darah (mmHg)</label>
            <input type="text" id="inputTDSebelum" placeholder="Contoh: 150/90">
          </div>
        </div>
        
        <div class="section-title">Sesudah Hemodialisa</div>
        <div class="input-row">
          <div class="input-group">
            <label>Berat Badan (kg)</label>
            <input type="number" id="inputBBSesudah" placeholder="Contoh: 62" step="0.1">
          </div>
          <div class="input-group">
            <label>Tekanan Darah (mmHg)</label>
            <input type="text" id="inputTDSesudah" placeholder="Contoh: 120/80">
          </div>
        </div>
        
        <div class="section-title">Data Tambahan</div>
        <div class="input-row">
          <div class="input-group">
            <label>Golongan Darah</label>
            <select id="inputGolonganDarah">
              <option value="">- Pilih -</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="AB">AB</option>
              <option value="O">O</option>
            </select>
          </div>
          <div class="input-group">
            <label>Tinggi Badan (cm)</label>
            <input type="number" id="inputTinggiBadan" placeholder="Contoh: 165" step="0.1">
          </div>
        </div>
        
        <div class="section-title">Tambahan</div>
        <div class="input-group">
          <label>Obat-obatan</label>
          <textarea id="inputObat" rows="2" placeholder="Input obat yang diberikan..."></textarea>
        </div>
        <div class="input-group">
          <label>Catatan</label>
          <input type="text" id="inputCatatan" placeholder="Catatan tambahan">
        </div>
        
        <button class="btn-save" id="btnSimpanRecord" onclick="simpanRecord()">SIMPAN PENCATATAN</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL VIEW -->
<div id="modalView" class="modal-view">
  <div class="modal-view-content">
    <div class="modal-view-header">
      <h4>Detail Jadwal Pasien</h4>
      <span class="modal-close" onclick="closeViewModal()">‚úï</span>
    </div>
    <div class="modal-view-body" id="modalViewBody"></div>
  </div>
</div>

<!-- MODAL HISTORY -->
<div id="modalHistory" class="modal-history">
  <div class="modal-history-content">
    <div class="modal-record-header">
      <h4>Riwayat Pencatatan</h4>
      <span class="modal-close" onclick="closeHistoryModal()">‚úï</span>
    </div>
    <div class="history-list" id="historyList"></div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast">Berhasil!</div>

<script>
// ===== VARIABEL GLOBAL =====
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSLoc7yUqr4bOCQ8hN8b7dkoxaiUPQMbi3B1lL4QmNRfhQxpKovP5OUd6j3Hc4I2cMdPk64k0KvXdQy/pub?gid=1350268941&single=true&output=csv";

// URL Google Apps Script Web App
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycby0IPbjixMW1PgNXatcRM4RNgGiQUbOHQ-O7aa0js8Ox3CkQhcr5XkPTkEJJMcqM63D/exec"; 

let dataPasien = [];
let currentUser = null;
let currentViewData = null;

// ===== INISIALISASI =====
document.addEventListener('DOMContentLoaded', function() {
  // Load data pasien
  fetch(CSV_URL)
    .then(r => r.text())
    .then(t => {
      const rows = t.trim().split("\n");
      rows.shift();
      dataPasien = rows.map(r => r.split(","));
    })
    .catch(err => {
      console.error('Error loading data:', err);
    });
  
  // Check existing session
  const savedUser = localStorage.getItem('hdAppUser');
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    showApp();
  }
  
  // Start clock
  tick();
  setInterval(tick, 1000);
});

// ===== CLOCK =====
function tick() {
  const c = document.getElementById('clock');
  const d = document.getElementById('clockDate');
  const n = new Date();
  c.textContent = n.toLocaleTimeString('id-ID', { hour12: false });
  d.textContent = n.toLocaleDateString('id-ID', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
}

// ===== TOGGLE FORM LOGIN / REGISTER =====
function showRegister() {
  document.getElementById('formLogin').style.display = 'none';
  document.getElementById('formRegister').style.display = 'block';
  document.getElementById('registerError').style.display = 'none';
}

function showLogin() {
  document.getElementById('formRegister').style.display = 'none';
  document.getElementById('formLogin').style.display = 'block';
  document.getElementById('loginError').style.display = 'none';
}

// ===== REGISTER =====
function doRegister() {
  const name = document.getElementById('registerName').value.trim();
  const ttl = document.getElementById('registerTTL').value.trim();
  const alamat = document.getElementById('registerAlamat').value.trim();
  const username = document.getElementById('registerUsername').value.trim().toLowerCase();
  const password = document.getElementById('registerPassword').value;
  const confirm = document.getElementById('registerConfirm').value;
  
  const errorEl = document.getElementById('registerError');
  
  if (!name || !ttl || !alamat || !username || !password || !confirm) {
    errorEl.textContent = 'Semua field harus diisi!';
    errorEl.style.display = 'block';
    return;
  }
  
  if (password.length < 4) {
    errorEl.textContent = 'Kata sandi minimal 4 karakter!';
    errorEl.style.display = 'block';
    return;
  }
  
  if (password !== confirm) {
    errorEl.textContent = 'Konfirmasi kata sandi tidak cocok!';
    errorEl.style.display = 'block';
    return;
  }
  
  const registeredUsers = JSON.parse(localStorage.getItem('hdAppRegisteredUsers') || '[]');
  
  if (registeredUsers.find(u => u.username === username)) {
    errorEl.textContent = 'Nama pengguna sudah digunakan!';
    errorEl.style.display = 'block';
    return;
  }
  
  const newUser = {
    username: username,
    password: password,
    name: name,
    ttl: ttl,
    alamat: alamat
  };
  
  registeredUsers.push(newUser);
  localStorage.setItem('hdAppRegisteredUsers', JSON.stringify(registeredUsers));
  
  showToast('Pendaftaran berhasil! Silakan login.');
  showLogin();
  document.getElementById('loginUsername').value = username;
}

// ===== LOGIN =====
function doLogin() {
  const username = document.getElementById('loginUsername').value.trim().toLowerCase();
  const password = document.getElementById('loginPassword').value;
  
  const registeredUsers = JSON.parse(localStorage.getItem('hdAppRegisteredUsers') || '[]');
  let user = registeredUsers.find(u => u.username === username && u.password === password);
  
  if (!user) {
    const defaultUsers = [
      { username: "iman", password: "123456", name: "Iman Waluyo", ttl: "Bandung, 01-01-1990", alamat: "Bandung" },
      { username: "ros", password: "123456", name: "Cik Ros", ttl: "Bandung, 02-02-1990", alamat: "Bandung" },
      { username: "linda", password: "123456", name: "Linda", ttl: "Bandung, 03-03-1990", alamat: "Bandung" },
      { username: "maria", password: "123456", name: "Maria Wahyu", ttl: "Bandung, 04-04-1990", alamat: "Bandung" },
      { username: "findy", password: "123456", name: "Findy A", ttl: "Bandung, 05-05-1990", alamat: "Bandung" },
      { username: "agus", password: "123456", name: "Samsuga / Agus", ttl: "Bandung, 06-06-1990", alamat: "Bandung" }
    ];
    user = defaultUsers.find(u => u.username === username && u.password === password);
  }
  
  if (user) {
    currentUser = {
      username: user.username,
      name: user.name,
      ttl: user.ttl || '-',
      alamat: user.alamat || '-'
    };
    localStorage.setItem('hdAppUser', JSON.stringify(currentUser));
    document.getElementById('loginError').style.display = 'none';
    showApp();
  } else {
    document.getElementById('loginError').textContent = 'Nama pengguna atau kata sandi salah!';
    document.getElementById('loginError').style.display = 'block';
  }
}

function showApp() {
  document.getElementById('modalLogin').classList.remove('show');
  document.getElementById('userBar').style.display = 'flex';
  document.getElementById('displayUserName').textContent = currentUser.name;
  document.getElementById('displayUserDetails').textContent = currentUser.ttl + ' | ' + currentUser.alamat;
  document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
  document.getElementById('hasil').innerHTML = 'Ketik minimal 2 karakter atau pilih tanggal untuk mencari';
}

function logout() {
  currentUser = null;
  localStorage.removeItem('hdAppUser');
  document.getElementById('modalLogin').classList.add('show');
  document.getElementById('userBar').style.display = 'none';
  document.getElementById('hasil').innerHTML = 'Silakan login terlebih dahulu untuk mencari data pasien';
  showLogin();
}

// ===== TOGGLE WA PANEL =====
function toggleWA() {
  document.getElementById('waPanel').classList.toggle("show");
}

// ===== CHECK DATE INPUT =====
function checkDate() {
  const wrapper = document.getElementById('dateWrapper');
  const input = document.getElementById('searchDate');
  if (input.value) {
    wrapper.classList.add('has-value');
  } else {
    wrapper.classList.remove('has-value');
  }
}

// ===== PARSE TANGGAL =====
function parseTanggal(t) {
  const b = {
    januari: 0, februari: 1, maret: 2, april: 3, mei: 4, juni: 5,
    juli: 6, agustus: 7, september: 8, oktober: 9, november: 10, desember: 11
  };
  const p = t.toLowerCase().split(" ");
  if (p.length < 3) return null;
  return new Date(p[2], b[p[1]], p[0]);
}

// ===== GET TARGET TIME =====
function getTarget(t, s) {
  const d = parseTanggal(t);
  if (!d) return new Date();
  s == "1" ? d.setHours(6, 30, 0, 0) : d.setHours(13, 0, 0, 0);
  return d;
}

// ===== CARI PASIEN =====
function cari() {
  if (!currentUser) {
    showToast('Silakan login terlebih dahulu');
    return;
  }
  
  const k = document.getElementById('search').value.toLowerCase();
  const dateInput = document.getElementById('searchDate').value;
  
  checkDate();
  
  if (k.length < 2 && !dateInput) {
    document.getElementById('hasil').innerHTML = "Ketik minimal 2 karakter atau pilih tanggal";
    return;
  }

  let out = "";
  
  dataPasien.forEach((r, idx) => {
    let isTextMatch = true;
    if (k.length >= 2) {
      isTextMatch = r.join(" ").toLowerCase().includes(k);
    }

    let isDateMatch = true;
    if (dateInput) {
      const rowDate = parseTanggal(r[4]);
      if (rowDate) {
        const d = rowDate.getDate();
        const m = rowDate.getMonth() + 1;
        const y = rowDate.getFullYear();
        const formattedRowDate = `${y}-${m < 10 ? '0' : ''}${m}-${d < 10 ? '0' : ''}${d}`;
        isDateMatch = (formattedRowDate === dateInput);
      } else {
        isDateMatch = false;
      }
    }

    if (isTextMatch && isDateMatch) {
      const target = getTarget(r[4], r[7]);
      const selesai = new Date() > target;
      const sisa = target - new Date();
      
      const pData = {
        nama: r[1],
        mr: r[0],
        ruang: r[2],
        hari: r[3],
        tanggal: r[4],
        bed: r[5],
        tim: r[6],
        shift: r[7],
        jam: r[8],
        selesai: selesai,
        sisa: sisa
      };
      const pDataStr = encodeURIComponent(JSON.stringify(pData));
      
      const shareText = `*JADWAL PASIEN HD*\n====================\nNama: ${r[1]}\nMR: XX${r[0].slice(-4)}\nRuang: ${r[2]}\nHari: ${r[3]}\nTanggal: ${r[4]}\nBed: ${r[5]}\nTim: ${r[6]}\nShift: ${r[7]}\nJam: ${r[8]}\n====================\n_Info Jadwal HD Malahayati_`;
      const shareTextEncoded = encodeURIComponent(shareText);

      out += `
      <div class="card ${selesai ? 'selesai' : ''}">
        <div class="row">
          <div class="nama">${r[1]}</div>
          <div class="mr">MR<br><b>XX${r[0].slice(-4)}</b></div>
        </div>
        <div class="info">
          Ruang: ${r[2]}<br>
          Hari: ${r[3]}<br>
          Tanggal: ${r[4]}<br>
          Bed: ${r[5]}<br>
          Tim: ${r[6]}<br>
          <span class="badge">Shift ${r[7]}</span>
          ${(!selesai && sisa > 0) ? `<div class="countdown">Mulai dalam ${Math.floor(sisa / 3600000)} jam</div>` : ""}
          Jam: ${r[8]}<br>
          <div style="margin-top:10px;">
            <button class="action-btn record-btn" onclick='openRecordModal(decodeURIComponent("${pDataStr}"))'>Pencatatan</button>
            <button class="action-btn view-btn" onclick='openViewModal(decodeURIComponent("${pDataStr}"))'>View</button>
          </div>
          <div style="margin-top:8px; display:flex; gap:4px; flex-wrap:wrap;">
            <a href="https://wa.me/?text=${shareTextEncoded}" target="_blank" class="action-btn wa-share-btn">WA</a>
            <a href="https://t.me/share/url?url=&text=${shareTextEncoded}" target="_blank" class="action-btn tg-share-btn">Telegram</a>
            <a href="sms:?body=${shareTextEncoded}" class="action-btn sms-btn">SMS</a>
          </div>
        </div>
      </div>`;
    }
  });
  
  document.getElementById('hasil').innerHTML = out || "Data tidak ditemukan";
}

// ===== MODAL RECORD =====
function openRecordModal(dataStr) {
  try {
    const pData = typeof dataStr === 'string' ? JSON.parse(dataStr) : dataStr;
    
    document.getElementById('recordPatientName').textContent = pData.nama;
    document.getElementById('recordMRDisplay').textContent = 'XX' + pData.mr.slice(-4);
    document.getElementById('recordMR').value = pData.mr;
    document.getElementById('recordNama').value = pData.nama;
    
    // Clear inputs
    document.getElementById('inputBBSebelum').value = '';
    document.getElementById('inputTDSebelum').value = '';
    document.getElementById('inputBBSesudah').value = '';
    document.getElementById('inputTDSesudah').value = '';
    document.getElementById('inputGolonganDarah').value = '';
    document.getElementById('inputTinggiBadan').value = '';
    document.getElementById('inputObat').value = '';
    document.getElementById('inputCatatan').value = '';
    
    document.getElementById('modalRecord').classList.add('show');
    document.body.style.overflow = 'hidden';
  } catch (e) {
    console.error('Error opening record modal:', e);
  }
}

function closeRecordModal() {
  document.getElementById('modalRecord').classList.remove('show');
  document.body.style.overflow = '';
}

// ===== SIMPAN RECORD =====
async function simpanRecord() {
  const btn = document.getElementById('btnSimpanRecord');
  const originalText = btn.innerHTML;
  
  const record = {
    timestamp: new Date().toISOString(),
    tanggal: new Date().toLocaleDateString('id-ID'),
    waktu: new Date().toLocaleTimeString('id-ID'),
    mr: document.getElementById('recordMR').value,
    namaPasien: document.getElementById('recordNama').value,
    bbSebelum: document.getElementById('inputBBSebelum').value,
    tdSebelum: document.getElementById('inputTDSebelum').value,
    bbSesudah: document.getElementById('inputBBSesudah').value,
    tdSesudah: document.getElementById('inputTDSesudah').value,
    golonganDarah: document.getElementById('inputGolonganDarah').value,
    tinggiBadan: document.getElementById('inputTinggiBadan').value,
    obat: document.getElementById('inputObat').value,
    catatan: document.getElementById('inputCatatan').value,
    petugas: currentUser.name
  };
  
  // Validasi minimal
  if (!record.bbSebelum && !record.tdSebelum && !record.bbSesudah && !record.tdSesudah && !record.golonganDarah && !record.tinggiBadan) {
    showToast('Isi minimal satu data pencatatan');
    return;
  }
  
  // Show loading
  btn.disabled = true;
  btn.innerHTML = '<span class="loading-spinner"></span> Menyimpan...';
  
  try {
    // Kirim ke Google Spreadsheet via Apps Script
    await fetch(GAS_WEBAPP_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(record)
    });
    
    // Save to localStorage as backup/history
    const historyKey = 'hdAppHistory_' + currentUser.username;
    let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
    history.unshift({ ...record, localId: Date.now() });
    
    if (history.length > 100) history = history.slice(0, 100);
    localStorage.setItem(historyKey, JSON.stringify(history));
    
    closeRecordModal();
    showToast('Pencatatan berhasil disimpan');
    
  } catch (error) {
    console.error('Error saving record:', error);
    
    // Save to localStorage only if failed
    const historyKey = 'hdAppHistory_' + currentUser.username;
    let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
    history.unshift({ ...record, localId: Date.now(), syncStatus: 'pending' });
    
    if (history.length > 100) history = history.slice(0, 100);
    localStorage.setItem(historyKey, JSON.stringify(history));
    
    closeRecordModal();
    showToast('Disimpan lokal (gagal sync ke server)');
  }
  
  btn.disabled = false;
  btn.innerHTML = originalText;
}

// ===== MODAL VIEW =====
function openViewModal(dataStr) {
  try {
    const pData = typeof dataStr === 'string' ? JSON.parse(dataStr) : dataStr;
    currentViewData = pData;
    
    const statusText = pData.selesai ? 'Sudah Selesai' : 
      (pData.sisa > 0 ? `Dimulai dalam ${Math.floor(pData.sisa / 3600000)} jam ${Math.floor((pData.sisa % 3600000) / 60000)} menit` : 'Sedang Berlangsung');
    
    const shareText = `*JADWAL PASIEN HD*\n====================\nNama: ${pData.nama}\nMR: XX${pData.mr.slice(-4)}\nRuang: ${pData.ruang}\nHari: ${pData.hari}\nTanggal: ${pData.tanggal}\nBed: ${pData.bed}\nTim: ${pData.tim}\nShift: ${pData.shift}\nJam: ${pData.jam}\n====================\n_Info Jadwal HD Malahayati_`;
    const shareTextEncoded = encodeURIComponent(shareText);
    
    const bodyHtml = `
    <div class="view-card" style="margin:20px;">
      <div class="view-card-header">
        <h3 class="view-patient-name">${pData.nama}</h3>
        <div class="view-patient-mr">MR: XX${pData.mr.slice(-4)}</div>
      </div>
      <div class="view-card-body">
        <div class="view-item">
          <span class="view-label"><span class="view-label-icon">üè•</span>Ruang</span>
          <span class="view-value">${pData.ruang}</span>
        </div>
        <div class="view-item">
          <span class="view-label"><span class="view-label-icon">üìÖ</span>Hari</span>
          <span class="view-value">${pData.hari}</span>
        </div>
        <div class="view-item">
          <span class="view-label"><span class="view-label-icon">üìÜ</span>Tanggal</span>
          <span class="view-value">${pData.tanggal}</span>
        </div>
        <div class="view-item">
          <span class="view-label"><span class="view-label-icon">üõèÔ∏è</span>Bed</span>
          <span class="view-value">${pData.bed}</span>
        </div>
        <div class="view-item">
          <span class="view-label"><span class="view-label-icon">üë•</span>Tim</span>
          <span class="view-value">${pData.tim}</span>
        </div>
        <div class="view-item">
          <span class="view-label"><span class="view-label-icon">‚è∞</span>Shift</span>
          <span class="view-badge">Shift ${pData.shift}</span>
        </div>
        <div class="view-item">
          <span class="view-label"><span class="view-label-icon">üïê</span>Jam</span>
          <span class="view-value">${pData.jam}</span>
        </div>
        <div style="text-align:center; padding:12px; background:linear-gradient(135deg, rgba(255,193,7,0.2) 0%, rgba(255,152,0,0.2) 100%); border-radius:10px; margin-top:12px;">
          <div style="font-size:12px; font-weight:700; color:var(--orange-dark);">${statusText}</div>
        </div>
        <div style="margin-top:15px; display:flex; gap:6px; flex-wrap:wrap; justify-content:center;">
          <a href="https://wa.me/?text=${shareTextEncoded}" target="_blank" class="action-btn wa-share-btn">Share WA</a>
          <a href="https://t.me/share/url?url=&text=${shareTextEncoded}" target="_blank" class="action-btn tg-share-btn">Telegram</a>
          <a href="sms:?body=${shareTextEncoded}" class="action-btn sms-btn">SMS</a>
        </div>
      </div>
    </div>`;
    
    document.getElementById('modalViewBody').innerHTML = bodyHtml;
    document.getElementById('modalView').classList.add('show');
    document.body.style.overflow = 'hidden';
  } catch (e) {
    console.error('Error opening view modal:', e);
  }
}

function closeViewModal() {
  document.getElementById('modalView').classList.remove('show');
  document.body.style.overflow = '';
  currentViewData = null;
}

// ===== MODAL HISTORY =====
function openHistoryModal() {
  if (!currentUser) {
    showToast('Silakan login terlebih dahulu');
    return;
  }
  
  const historyKey = 'hdAppHistory_' + currentUser.username;
  const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
  
  let html = '';
  
  if (history.length === 0) {
    html = '<div class="history-empty">Belum ada riwayat pencatatan</div>';
  } else {
    history.forEach((item, idx) => {
      html += `
      <div class="history-item">
        <div class="history-item-header">
          <div>
            <div class="history-date">${item.tanggal} - ${item.waktu}</div>
            <div class="history-patient">${item.namaPasien} (MR: XX${item.mr.slice(-4)})</div>
          </div>
        </div>
        <div class="history-data">
          <div class="history-data-item">
            <label>BB Sebelum</label>
            <span>${item.bbSebelum || '-'} kg</span>
          </div>
          <div class="history-data-item">
            <label>TD Sebelum</label>
            <span>${item.tdSebelum || '-'} mmHg</span>
          </div>
          <div class="history-data-item">
            <label>BB Sesudah</label>
            <span>${item.bbSesudah || '-'} kg</span>
          </div>
          <div class="history-data-item">
            <label>TD Sesudah</label>
            <span>${item.tdSesudah || '-'} mmHg</span>
          </div>
          <div class="history-data-item">
            <label>Gol. Darah</label>
            <span>${item.golonganDarah || '-'}</span>
          </div>
          <div class="history-data-item">
            <label>Tinggi Badan</label>
            <span>${item.tinggiBadan || '-'} cm</span>
          </div>
        </div>
        ${item.obat ? `<div style="margin-top:8px; font-size:11px; color:#666;"><strong>Obat:</strong> ${item.obat}</div>` : ''}
        ${item.catatan ? `<div style="margin-top:4px; font-size:11px; color:#666;"><strong>Catatan:</strong> ${item.catatan}</div>` : ''}
        <div class="history-actions">
          <button class="action-btn pdf-btn" onclick="generatePDF(${idx})">üìÑ Cetak PDF</button>
          <button class="action-btn wa-share-btn" onclick="shareViaWA(${idx})">üì± Kirim WA</button>
          <button class="action-btn delete-btn" onclick="deleteHistory(${idx})">üóëÔ∏è Hapus</button>
        </div>
      </div>`;
    });
  }
  
  document.getElementById('historyList').innerHTML = html;
  document.getElementById('modalHistory').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeHistoryModal() {
  document.getElementById('modalHistory').classList.remove('show');
  document.body.style.overflow = '';
}

// ===== DELETE HISTORY =====
function deleteHistory(idx) {
  if (confirm('Yakin ingin menghapus riwayat ini?')) {
    const historyKey = 'hdAppHistory_' + currentUser.username;
    let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
    
    if (idx > -1 && idx < history.length) {
      history.splice(idx, 1);
      localStorage.setItem(historyKey, JSON.stringify(history));
      openHistoryModal(); // Refresh modal
      showToast('Riwayat berhasil dihapus');
    }
  }
}

// ===== GENERATE PDF =====
function generatePDF(idx) {
  const historyKey = 'hdAppHistory_' + currentUser.username;
  const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
  
  if (!history[idx]) {
    showToast('Data tidak ditemukan');
    return;
  }
  
  const item = history[idx];
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Header
  doc.setFontSize(16);
  doc.setFont('helvetica', 'bold');
  doc.text('CATATAN HARIAN HEMODIALISA', 105, 20, { align: 'center' });

  doc.setFontSize(12);
  doc.setFont('helvetica', 'normal');
  doc.text('INSTALASI DIALISIS RSSA Ruang HD Malahayati', 105, 28, { align: 'center' });
  
  // Line
  doc.setLineWidth(0.5);
  doc.line(20, 35, 190, 35);
  
  // Patient Info
  doc.setFontSize(11);
  let y = 45;
  
  doc.setFont('helvetica', 'bold');
  doc.text('Data Pasien:', 20, y);
  y += 8;
  
  doc.setFont('helvetica', 'normal');
  doc.text(`Nama: ${item.namaPasien}`, 25, y);
  y += 6;
  doc.text(`No. MR: XX${item.mr.slice(-4)}`, 25, y);
  y += 6;
  doc.text(`Golongan Darah: ${item.golonganDarah || '-'}`, 25, y);
  y += 6;
  doc.text(`Tinggi Badan: ${item.tinggiBadan || '-'} cm`, 25, y);
  y += 6;
  doc.text(`Tanggal: ${item.tanggal}`, 25, y);
  y += 6;
  doc.text(`Waktu: ${item.waktu}`, 25, y);
  y += 6;
  doc.text(`Petugas: ${item.petugas}`, 25, y);
  y += 15;
  
  // Table Data
  doc.setFont('helvetica', 'bold');
  doc.text('Data Pencatatan:', 20, y);
  y += 8;
  
  doc.autoTable({
    startY: y,
    head: [['Parameter', 'Sebelum HD', 'Sesudah HD']],
    body: [
      ['Berat Badan (kg)', item.bbSebelum || '-', item.bbSesudah || '-'],
      ['Tekanan Darah (mmHg)', item.tdSebelum || '-', item.tdSesudah || '-']
    ],
    theme: 'grid',
    headStyles: { fillColor: [46, 125, 50] },
    margin: { left: 20, right: 20 }
  });
  
  y = doc.lastAutoTable.finalY + 15;
  
  // Obat & Catatan
  if (item.obat) {
    doc.setFont('helvetica', 'bold');
    doc.text('Obat-obatan:', 20, y);
    y += 6;
    doc.setFont('helvetica', 'normal');
    const obatLines = doc.splitTextToSize(item.obat, 170);
    doc.text(obatLines, 25, y);
    y += (obatLines.length * 5) + 5;
  }
  
  if (item.catatan) {
    doc.setFont('helvetica', 'bold');
    doc.text('Catatan:', 20, y);
    y += 6;
    doc.setFont('helvetica', 'normal');
    const catatanLines = doc.splitTextToSize(item.catatan, 170);
    doc.text(catatanLines, 25, y);
  }
  
  // Footer
  const pageHeight = doc.internal.pageSize.height;
  doc.setFontSize(8);
  doc.setFont('helvetica', 'italic');
  doc.text(`Dicetak pada: ${new Date().toLocaleString('id-ID')}`, 105, pageHeight - 10, { align: 'center' });
  
  // Save
  const fileName = `HD_${item.namaPasien.replace(/\s+/g, '_')}_${item.tanggal.replace(/\//g, '-')}.pdf`;
  doc.save(fileName);
  
  showToast('PDF berhasil diunduh');
}

// ===== SHARE VIA WA =====
function shareViaWA(idx) {
  const historyKey = 'hdAppHistory_' + currentUser.username;
  const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
  
  if (!history[idx]) {
    showToast('Data tidak ditemukan');
    return;
  }
  
  const item = history[idx];
  
  const text = `*CATATAN HEMODIALISA*
RS Malahayati
==================
Nama: ${item.namaPasien}
MR: XX${item.mr.slice(-4)}
Golongan Darah: ${item.golonganDarah || '-'}
Tinggi Badan: ${item.tinggiBadan || '-'} cm
Tanggal: ${item.tanggal}
Waktu: ${item.waktu}
Petugas: ${item.petugas}
------------------
*Sebelum HD:*
BB: ${item.bbSebelum || '-'} kg
TD: ${item.tdSebelum || '-'} mmHg

*Sesudah HD:*
BB: ${item.bbSesudah || '-'} kg
TD: ${item.tdSesudah || '-'} mmHg
------------------
*Obat:* ${item.obat || '-'}
*Catatan:* ${item.catatan || '-'}
==================
_Dicetak dari Aplikasi HD Malahayati_`;

  const encodedText = encodeURIComponent(text);
  const waUrl = `https://wa.me/?text=${encodedText}`;
  
  window.open(waUrl, '_blank');
}

// ===== TOAST =====
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ===== CLOSE MODAL ON OUTSIDE CLICK =====
document.getElementById('modalRecord').addEventListener('click', function(e) {
  if (e.target === this) closeRecordModal();
});
document.getElementById('modalView').addEventListener('click', function(e) {
  if (e.target === this) closeViewModal();
});
document.getElementById('modalHistory').addEventListener('click', function(e) {
  if (e.target === this) closeHistoryModal();
});

// ===== CLOSE MODAL ON ESCAPE KEY =====
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeRecordModal();
    closeViewModal();
    closeHistoryModal();
  }
});
</script>

</body>
</html>
